!function(t){t.nbeatselect=function(t,e){this.init(t,e)},t.extend(t.nbeatselect.prototype,{settings:{sortBy:"score",preSelection:!0,selectedClass:"nbeatselect-selected",dropdownClass:"nbeatselect-dropdown",showDisabledOptions:!1,autoSubmit:!1,formId:null,inputIdTransform:function(t){return t+"-nbeatselect"},inputNameTransform:function(t){},dropdownIdTransform:function(t){return t+"-nbeatselect-dropdown"}},debug:!1,select:null,inputContainer:null,input:null,button:null,icon:null,dropdown:null,dropdownList:null,label:null,cache:[],results:[],lastAbbreviation:null,abbreviationBeforeFocus:null,selectedIndex:0,picked:!1,allowMouseMove:!0,dropdownMouseover:!1,indexOptgroupLabels:!1,visible:!1,init:function(e,s){this.settings=t.extend({},this.settings,s),this.select=t(e),this.reloadCache(),this.renderControls(),this.handleEvents(),this.setPreselectedIcon()},reloadCache:function(){var e,s,i,n,o=this.settings.indexOptgroupLabels;this.cache=this.select.find("option").map(function(){return e=t(this).text(),s=t(this).parent("optgroup").attr("label"),i=o?[e,s].join(" "):e,n=t(this).parent("optgroup").attr("disabled")||t(this).attr("disabled"),{text:t.trim(i),name:t.trim(e),value:t(this).val(),disabled:n,score:0}})},renderControls:function(){var e=this.settings.preSelection?this.select.find("option:selected"):null;this.inputContainer=t("<div>").addClass("nbeatselect-container"),this.input=t('<input type="text" autocomplete="off" />').attr({id:this.settings.inputIdTransform(this.select.attr("id")),name:this.settings.inputNameTransform(this.select.attr("name")),accesskey:this.select.attr("accesskey"),tabindex:this.select.attr("tabindex"),style:this.select.attr("style"),placeholder:this.select.attr("data-placeholder")}).addClass(this.select.attr("class")).attr("required",this.select.attr("required")).val(t.trim(e?e.text():"")).css({visibility:"visible"}),this.icon=t("<span>").attr({id:this.settings.inputIdTransform(this.select.attr("id"))+"-icon"}).addClass("icon icon-expand"),this.button=t("<div>").attr({id:this.settings.inputIdTransform(this.select.attr("id"))+"-button",tabindex:0}).addClass("nbeatselect-icon").attr("role","button").attr("tabindex","-1"),this.label=t("<label>").attr({id:this.settings.inputIdTransform(this.select.attr("id"))+"-label",tabindex:0}).text(this.select.attr("data-placeholder")).attr("tabindex","-1"),this.dropdown=t("<div></div>").attr({id:this.settings.dropdownIdTransform(this.select.attr("id"))}).addClass(this.settings.dropdownClass),this.dropdownList=t("<ul></ul>"),this.dropdown.append(this.dropdownList),this.button.append(this.icon),this.inputContainer.append(this.input),this.inputContainer.append(this.button),this.inputContainer.append(this.label),this.select.after(this.inputContainer),this.select.hide(),t("body").append(this.dropdown)},handleEvents:function(){this.registerInputEvents(),this.registerDropdownEvents(),this.registerButtonEvents()},setPreselectedIcon:function(){""!=this.input.val()&&this.setClearIcon()},registerInputEvents:function(){var e=this;this.input.click(function(){!0===e.debug&&console.log("input: click"),e.lastAbbreviation=null,e.focus(),e.renderDropdown()}),this.input.mouseup(function(t){!0===e.debug&&console.log("input: mouseup"),t.preventDefault()}),this.input.focus(function(){!0===e.debug&&console.log("input: focus"),e.abbreviationBeforeFocus=e.input.val(),e.input[0].setSelectionRange(0,e.input.val().length),e.picked||e.filterResults()}),this.input.blur(function(){!0===e.debug&&console.log("input: blur"),e.dropdownMouseover||(e.hide(),e.input.val().length<1&&e.setDefaultIcon())});var s=this.input;this.select.change(function(){!0===e.debug&&console.log("input: change"),s.val(t.trim(t(this).find("option:selected").text()))}),this.input.keyup(function(t){switch(!0===e.debug&&console.log("input: keyup"),t.keyCode){case 13:!0===e.debug&&console.log("input: enter"),t.preventDefault(),!0===e.isVisible()?(e.pickSelected(),e.focusAndHide()):(e.focusAndHide(),e.pickSelected(),e.submit(),e.setClearIcon());break;case 27:!0===e.debug&&console.log("input: escape"),t.preventDefault(),e.reset(),e.focusAndHide();break;case 40:case 38:break;default:e.filterResults()}}),this.input.keydown(function(t){switch(t.keyCode){case 9:e.pickSelected(),e.hide(),e.setClearIcon();break;case 33:t.preventDefault(),e.markFirst();break;case 34:t.preventDefault(),e.markLast();break;case 38:t.preventDefault(),e.moveSelected(-1);break;case 40:t.preventDefault(),e.moveSelected(1);break;case 13:case 27:t.preventDefault(),t.stopPropagation()}})},registerDropdownEvents:function(){var e=this;this.dropdownList.mouseover(function(s){if(!0===e.debug&&console.log("dropdownList: mouseover"),e.allowMouseMove){if("LI"==s.target.tagName){var i=e.dropdown.find("li");e.markSelected(i.index(t(s.target)))}}else e.allowMouseMove=!0}),this.dropdownList.mouseleave(function(){!0===e.debug&&console.log("dropdownList: mouseleave"),e.markSelected(-1)}),this.dropdownList.mouseup(function(t){!0===e.debug&&console.log("dropdownList: mouseup"),e.pickSelected(),e.focusAndHide(),e.setClearIcon(),e.submit()}),this.dropdownList.bind("touchstart",function(s){if(!0===e.debug&&console.log("dropdownList: touchstart"),"LI"==s.target.tagName){var i=e.dropdown.find("li");e.markSelected(i.index(t(s.target)))}}),this.dropdown.mouseover(function(t){!0===e.debug&&console.log("dropdown: mouseover"),e.dropdownMouseover=!0}),this.dropdown.mouseleave(function(t){!0===e.debug&&console.log("dropdown: mouseleave"),e.dropdownMouseover=!1}),this.dropdown.mousedown(function(t){!0===e.debug&&console.log("dropdown: mousedown"),t.preventDefault()})},registerButtonEvents:function(){var t=this;this.button.mousedown(function(e){!0===t.debug&&console.log("icon: click"),e.preventDefault(),e.stopPropagation(),t.icon.hasClass("icon-remove")?(t.fullReset(),t.input.focus(),t.markSelected(0),t.pickSelected(),t.submit()):t.icon.hasClass("icon-expand")&&(t.focus(),t.dropdown.show())}),this.button.keydown(function(e){switch(e.keyCode){case 13:e.preventDefault(),e.stopPropagation(),t.fullReset(),t.input.focus()}})},filterResults:function(){var e=this.settings.showDisabledOptions,s=this.input.val(),i=[],n=this.input.val();s!=this.lastAbbreviation&&(t.each(this.cache,function(){this.disabled&&!e||(this.score=NbeatSelectSorter.score(this.text,s),this.score>0&&i.push(this))}),this.results=i,""==n||"name"==this.settings.sortBy?this.sortResultsByName():this.sortResultsByScore(),this.renderDropdown(),this.markFirst(),this.lastAbbreviation=s,this.picked=!1,this.allowMouseMove=!1,0===n.length?this.removeIcon():n.length>0&&this.setClearIcon())},sortResultsByScore:function(){this.results.sort(function(t,e){return e.score-t.score})},sortResultsByName:function(){this.results.sort(function(t,e){return t.name<e.name?-1:t.name>e.name?1:0})},renderDropdown:function(){var e=this.settings.showDisabledOptions,s=this.dropdown.outerWidth()-this.dropdown.innerWidth(),i=this.inputContainer.offset(),n="",o="";this.dropdown.css({width:this.inputContainer.outerWidth()-s+2+"px",top:i.top+this.inputContainer.outerHeight()+"px",left:i.left+"px",maxHeight:""}),t.each(this.results,function(){this.disabled&&!e||(o=this.disabled?' class="disabled"':"",n+="<li"+o+">"+this.name+"</li>")}),this.dropdownList.html(n),this.adjustMaxHeight(),this.dropdown.show()},adjustMaxHeight:function(){var e=t(window).height()+t(window).scrollTop()-this.dropdown.outerHeight(),s=parseInt(this.dropdown.css("top"),10),i=s>e?Math.max(0,e-s+this.dropdown.innerHeight())+"px":"";this.dropdown.css("max-height",i)},markSelected:function(e){if(!(e<0||e>=this.results.length)){var s=this.dropdown.find("li"),i=t(s[e]),n=i.position().top,o=n+i.outerHeight()-this.dropdown.height();i.hasClass("disabled")?this.selectedIndex=null:(this.selectedIndex=e,s.removeClass(this.settings.selectedClass),i.addClass(this.settings.selectedClass),o>0?(this.allowMouseMove=!1,this.dropdown.scrollTop(this.dropdown.scrollTop()+o)):n<0&&(this.allowMouseMove=!1,this.dropdown.scrollTop(Math.max(0,this.dropdown.scrollTop()+n))))}},pickSelected:function(){var t=this.results[this.selectedIndex];t&&!t.disabled?(this.input.val(t.name),this.setValue(t.value),this.picked=!0,this.input.addClass("filled")):this.reset()},setValue:function(t){this.select.val()!==t&&this.select.val(t).change()},hide:function(){this.dropdown.hide(),this.lastAbbreviation=null,this.visible=!1},moveSelected:function(t){this.markSelected(this.selectedIndex+t)},markFirst:function(){this.markSelected(0)},markLast:function(){this.markSelected(this.results.length-1)},reset:function(){this.input.val(this.abbreviationBeforeFocus)},fullReset:function(){this.input.val(""),this.lastAbbreviation=null,this.picked=!1,this.input.removeClass("filled")},focus:function(){this.input.focus()},focusAndHide:function(){this.focus(),this.hide()},submit:function(){!0===this.settings.autoSubmit&&t("#"+this.settings.formId).submit()},isVisible:function(){return!0===this.visible},removeIcon:function(){this.icon.removeClass("icon-expand icon-remove")},setDefaultIcon:function(){this.icon.removeClass("icon-remove").addClass("icon-expand")},setClearIcon:function(){this.icon.removeClass("icon-expand").addClass("icon-remove")},log:function(t){!0===this.debug&&console.log(t)}}),t.fn.nbeatselect=function(e){return this.each(function(){t(this).data("nbeatselect")?t(this).data("nbeatselect").reloadCache():"SELECT"==this.tagName&&t(this).data("nbeatselect",new t.nbeatselect(this,e))}),this}}(jQuery);